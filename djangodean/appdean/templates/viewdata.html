{% extends 'base.html' %}

{% block title %}Danh Sách Lô Sản Xuất{% endblock %}

{% block content %}
<h2 class="text-center">Dữ liệu nhà máy bia</h2>
<p class="text-center text-muted">Dữ liệu toàn diện các thông số pha chế, xu hướng bán hàng và số liệu chất lượng</p>
<div class="d-flex justify-content-between mb-3">
  <button type="button" class="btn btn-success me-3" id="btnExportToSheets">Xuất Dữ Liệu Sang Google Sheets</button>
  <button type="button" class="btn btn-danger" id="btnDeleteAll">Xóa Tất Cả Dữ Liệu</button>
</div>
<form id="formSearch">
  <div class="row">
    {% csrf_token %}
    <div class="col-md-6">
      <input type="text" class="form-control" placeholder="keyword" name="keyword" id="txtKeyword">
    </div>
    <div class="col-md-4">
      <select class="form-select" name="column" id="selColumn">
        <option value="batch_id">Batch ID</option>
        <option value="Brew_Date">Brew Date</option>
        <option value="Beer_Style">Beer Style</option>
        <option value="SKU">SKU</option>
        <option value="Location">Location</option>
        <option value="Fermentation_Time">Fermentation Time</option>
        <option value="Temperature">Temperature</option>
        <option value="pH_Level">pH Level</option>
        <option value="Gravity">Gravity</option>
        <option value="Alcohol_Content">Alcohol Content</option>
        <option value="Bitterness">Bitterness</option>
        <option value="Color">Color</option>
        <option value="Ingredient_Ratio">Ingredient Ratio</option>
        <option value="Volume_Produced">Volume Produced</option>

        <option value="Total_Sales">Total Sales</option>
        <option value="Quality_Score">Quality Score</option>
        <option value="Brewhouse_Efficiency">Brewhouse Efficiency</option>

        <option value="Loss_During_Brewing">During Brewing</option>
        <option value="Loss_During_Fermentation">During Fermentation</option>
        <option value="Loss_During_Bottling_Kegging">During Bottling/Kegging</option>
      </select>
    </div>
    <div class="col-md-2 d-grid">
      <button class="btn btn-primary btn-block" type="button" id="btnSearch">Tìm kiếm</button>
    </div>
  </div>
</form>
<br>
<table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Batch_ID</th>
            <th>Brew_Date</th>
            <th>Beer_Style</th>
            <th>SKU</th>
            <th class='action-item'>Hành động</th>
        </tr>
    </thead>
    <tbody>
        {% for x in mymembers %}
        <tr>
            <td>{{ x.batch_id }}</td>
            <td>{{ x.Brew_Date }}</td>
            <td>{{ x.Beer_Style }}</td>
            <td>{{ x.SKU }}</td>
            <td><a href="/detailview/?q={{ x.batch_id }}" class="btn btn-outline-primary">Thông tin</a>
                <form method="POST" action="/delete_record/" style="display:inline;" id="delete-form-{{ x.batch_id }}">
                  {% csrf_token %}
                  <input type="hidden" name="id" value="{{ x.batch_id }}">
                  <button type="submit" class="btn btn-outline-danger" onclick="return confirmDelete('{{ x.batch_id }}')">Xóa bản ghi</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<script>
  function confirmDelete(batchId) {
      return window.confirm('Bạn có chắc chắn muốn xóa bản ghi này?');
    }

  // Xử lý xuất dữ liệu sang Google Sheets
  document.getElementById('btnExportToSheets').onclick = function () {
    fetch('/export-all-to-sheets/', {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      }
    })
      .then(response => {
        if (response.ok) {
          return response.json();
        } else {
          throw new Error('Xuất dữ liệu thất bại');
        }
      })
      .then(data => {
        alert(data.message); // Hiển thị thông báo thành công
      })
      .catch(error => {
        console.error('Lỗi:', error);
        alert('Có lỗi xảy ra khi xuất dữ liệu');
      });
  };

  // Xử lý xóa tất cả dữ liệu
  document.getElementById('btnDeleteAll').onclick = function() {
    // Cảnh báo xác nhận
    let isConfirmed = window.confirm('Bạn có chắc chắn muốn xóa toàn bộ dữ liệu?');

    if (isConfirmed) {
      // Nếu người dùng xác nhận, thực hiện yêu cầu xóa toàn bộ dữ liệu
      fetch('/delete_all_records/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({'confirm': true})
      })
      .then(() => {
        // Tải lại trang sau khi xóa
        location.reload();  // Tải lại trang hiện tại
      })
      .catch(error => {
        console.error('Lỗi:', error);
        alert('Có lỗi xảy ra khi xóa dữ liệu.');
      });
    }
  };

  
  let txtKeyword = document.getElementById('txtKeyword');
  let selColumn = document.getElementById('selColumn');
  let btnSearch = document.getElementById('btnSearch');
  let formSearch = document.getElementById('formSearch');
  let table = document.querySelector('table.table-striped');

  selColumn.onchange = () => {
    if ('Brew_Date' === selColumn.value) {
      txtKeyword.type = 'date';
    } else {
      txtKeyword.type = 'text';
    }
  }

  function updateTable(datas) {
    const headTr = document.querySelector('thead tr');
    const tbody = table.querySelector('tbody');
    let newbody = document.createElement('tbody')

    let exist_columns = [
        "batch_id",
        "Brew_Date",
        "Beer_Style",
        "SKU"
    ];

    const isAdded = exist_columns.includes(selColumn.value);
    let addedColumn = document.querySelector('th.add-new-column');
    if (true === isAdded) {
        if (addedColumn) {
            headTr.removeChild(addedColumn);
        }
    } else {
        if (addedColumn) {

        } else {
            addedColumn = document.createElement('th');
            addedColumn.classList.add('add-new-column');
            let thAction = document.querySelector('thead th.action-item');
            headTr.insertBefore(addedColumn, thAction);
        }

        addedColumn.innerText = selColumn.value;
    }

    let rows = ''
    for (let i = 0; i < datas.length; i++) {
      let tr = `
        <tr>
            <td>${datas[i].batch_id }</td>
            <td>${datas[i].Brew_Date }</td>
            <td>${datas[i].Beer_Style }</td>
            <td>${datas[i].SKU }</td>`
            +
                (true === isAdded ? '': `<td>${datas[i][selColumn.value] }</td>`)
            +
        `   <td><a href="/detailview/?q=${datas[i].batch_id }" class="btn btn-outline-primary">Thông tin</a>
                <form method="POST" action="/delete_record/" style="display:inline;" id="delete-form-{{ x.batch_id }}">
                  {% csrf_token %}
                  <input type="hidden" name="id" value="${datas[i].batch_id }">
                  <button type="submit" class="btn btn-outline-danger" onclick="return confirmDelete('{{ x.batch_id }}')">Xóa</button>
                </form>
            </td>
        </tr>`
      rows += tr;
    }


    newbody.innerHTML = rows;
    table.removeChild(tbody);
    table.appendChild(newbody);
  }

  btnSearch.onclick = () => {
    let formData = new FormData(formSearch);

    fetch('/listview/', {
      method: "POST",
      body: formData
    }).then(result => {
      result.json().then(resp => {
        let values = JSON.parse(resp.datas);
        updateTable(values)
      })
      
    }).catch(error => {
      console.log(error)
    })
  }
</script>
{% endblock %}